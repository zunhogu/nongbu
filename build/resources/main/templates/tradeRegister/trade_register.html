<!DOCTYPE html>
<html lang="kr" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>농부아지야 - 계약재배 물품등록</title>
    <meta name="description">
    <meta name="author" content="">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" type="text/css" href="/tradeRegister/css/jquery-ui.css" />
    <link rel="stylesheet" type="text/css" href="/tradeRegister/css/css.css" />

    <script type="text/javascript">
        var cb_charset = "UTF-8";
        var cb_time_ymd = "2022-05-27";
        var is_member = "1";
        var is_admin = "";
		var editMode = "";
    </script>

    <script type="text/javascript" src="/tradeRegister/_layout/js/jquery-1.11.2.min.js"></script>
    <script type="text/javascript" src="/tradeRegister/_layout/js/jquery-ui-1.11.2.custom/jquery-ui.js"></script>

    <script type="text/javascript" src="/tradeRegister/assets/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/tradeRegister/assets/js/common.js"></script>
    <script type="text/javascript" src="/tradeRegister/assets/js/jquery.validate.min.js"></script>
    <script type="text/javascript" src="/tradeRegister/assets/js/jquery.validate.extension.js"></script>
    <script type="text/javascript" src="/tradeRegister/assets/js/jquery.tmpl.min.js"></script>
    <script type="text/javascript" src="/tradeRegister/assets/js/sideview.js"></script>
    <script type="text/javascript" src="/tradeRegister/assets/js/js.cookie.js"></script>

    <!-- service modified -->
    <script type="text/javascript" src="/tradeRegister/_layout/js/util.js"></script>
    <script type="text/javascript" src="/tradeRegister/_layout/js/layout.js"></script>
    <script type="text/javascript" src="/tradeRegister/_layout/js/member.js"></script>
    <script type="text/javascript" src="/tradeRegister/_layout/js/design.js"></script>

</head>

<body>


<div id="wrap">
    <!-- S : header -->
    <header id="header">
        <div class="wr_left">
            <div class="menu">
                <img src="/tradeRegister/images/datacenter.png" height="15px" style="margin: 0px 5px 5px 50px">데이터 센터
                <img src="/tradeRegister/images/trade.png" height="12px" style="margin: 0px 5px 0px 20px">선물거래
                <img src="/tradeRegister/images/news.png" height="12px" style="margin: 0px 5px 2px 20px">뉴스
                <img src="/tradeRegister/images/crowdfunding.png" height="12px" style="margin: 0px 5px 0px 20px">크라우드 펀딩
            </div>
        </div>
        <div class="floatr">
            <div style="padding: 0px 50px 0px 0px">
                <span>안녕하세요 user님</span>
            </div>
        </div>
    </header>
    <!-- E : header -->

	<body>
    <!-- content start -->
    <div id="container">
        <div id="searchareaCommon" class="searcharea">
            <div class="">
                <logo id="logo"><a href="http://nongbu.site/"><img src="/tradeRegister/logo.png" alt="" height="100px"></a>
                </logo>
                <span id="searchform_common" class="searchform logo" style="margin: 30px 0px 0px 0px">
                        <input type="text" value="" placeholder="검색">
                        <a href="#"><i class="fas fa-search"></i></a>
                    </span>
                <a href="#" class="detailsearch disinblock" style="margin: 30px 0px 0px 0px">상세검색<i
                        class="fas fa-chevron-down"></i></a>
            </div>
        </div>
        <div class="contents" style="background-image: url('../img/background.png'); background-size: cover">
            <div class="wrap_cont">
                <section class="dicwrite mt12">
                    <div class="tit">
                        <h2>계약재배 거래등록</h2>
                    </div>
                    <div class="nomargin mt15">
                        <div class="stit">
                            <h3><i class="fas fa-angle-right"></i>농가 정보</h3>
                            <div class="floatr">
                                <a href="#" id="formareaEnable" class="btn round mcolor"
                                   title="의미/용례, 이미지 입력 필드를 활성화 시킵니다.">활성화</a>
                                <a href="#" id="formareaDisable" class="btn round scolor"
                                   title="의미/용례, 이미지 입력 필드를 비활성화 시킵니다.">비활성화</a>
                            </div>
                        </div>
                        <div class="contarea">
                            <table class="tbl02 column2 shortinput">
                                <tbody>
                                <tr>
                                    <th>농가 주소</th>
                                    <td><input type="text" id="address" name="address" value="" placeholder=""
                                               onClick="setInputField(this, 'address'); return false;"></td>
                                </tr>
                                <tr>
                                    <th>농부 이름</th>
                                    <td><input type="text" id="farmer_name" name="farmer_name" value=""
                                               placeholder=""
                                               onClick="setInputField(this, 'farmer_name'); return false;">
                                    </td>
                                </tr>
                                <tr>
                                    <th>소속 협동조합</th>
                                    <td><input type="text" id="farmer_company" name="farmer_company" value=""
                                               placeholder=""
                                               onClick="setInputField(this, 'farmer_company'); return false;">
                                    </td>
                                </tr>
                                <tr class="meInfo">
                                    <th>농가 설명</th>
                                    <td>
                                        <div contenteditable class="imginput big" id="farmer_comment"
                                             onClick="setInputField(this, 'farmer_comment'); return false;">
                                        </div>
                                        <table class="tbl02 sm mt8">
                                            <tbody>
                                            <tr>
                                                <th>농부 이미지</th>
                                                <td class="withbtn01 delete"><input type="file" id="farmer_img"
                                                                                    name="farmerImgFile" style="display: none;"
                                                                                    onchange="farmerImgChangeHandler(this); return false;"><input
                                                        type="text" name="farmerSelectedImg" value=""
                                                        data-type="" data-size="0"
                                                        placeholder="이미지 파일을 선택해 주세요" disabled><a href="#"
                                                                                                  class="disinblock trash" title="삭제"
                                                                                                  onclick="trashSelClick(this); return false;"><i
                                                        class="fas fa-trash-alt"></i></a><a href="#"
                                                                                            class="btn grey"
                                                                                            onclick="farmerFileSelClick(this); return false;">파일선택</a>
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div id="formarea" class="formarea">
                        <div id="form_meExamInfo">
                            <div class="meExamInfo">
                                <div class="stit over">
                                    <h3><i class="fas fa-angle-right"></i>상품 기본정보</h3>
                                </div>
                                <div class="contarea">
                                    <table class="tbl02 column2">
                                        <tbody>
                                        <tr>
                                            <th>상품분류</th>
                                            <td><input type="text" id="product_category" name="product_category"
                                                       value="" placeholder=""
                                                       onClick="setInputField(this, 'product_category'); return false;">
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>상품명</th>
                                            <td><input type="text" id="product_name" name="product_name"
                                                       value="" placeholder=""
                                                       onClick="setInputField(this, 'product_name'); return false;">
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>상품 구성</th>
                                            <td><input type="text" id="product_attribute" name="product_attribute"
                                                       value="" placeholder=""
                                                       onClick="setInputField(this, 'product_attribute'); return false;">
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>판매 시기</th>
                                            <td><input type="text" id="sales_day" name="sales_day"
                                                       value="" placeholder=""
                                                       onClick="setInputField(this, 'sales_day'); return false;">
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>배송 조건</th>
                                            <td><input type="text" id="delivery_condition" name="delivery_condition"
                                                       value="" placeholder=""
                                                       onClick="setInputField(this, 'delivery_condition'); return false;">
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>지역</th>
                                            <td><input type="text" id="product_local" name="product_local"
                                                       value="" placeholder=""
                                                       onClick="setInputField(this, 'product_local'); return false;">
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>과세 여부</th>
                                            <td><input type="text" id="is_tax" name="is_tax"
                                                       value="" placeholder=""
                                                       onClick="setInputField(this, 'is_tax'); return false;">
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>출하 날짜</th>
                                            <td><input type="text" id="d_date" name="d_date"
                                                       value="" placeholder=""
                                                       onClick="setInputField(this, 'd_date'); return false;">
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>상품 이미지</th>
                                            <td class="withbtn01 delete"><input type="file" id="product_img"
                                                                                name="productImgFile" style="display: none;"
                                                                                onchange="farmerImgChangeHandler(this); return false;"><input
                                                    type="text" name="productSelectedImg" value="" data-type=""
                                                    data-size="0" placeholder="이미지 파일을 선택해 주세요" disabled><a
                                                    href="#" class="disinblock trash" title="삭제"
                                                    onclick="trashSelClick(this); return false;"><i
                                                    class="fas fa-trash-alt"></i></a><a href="#"
                                                                                        class="btn grey"
                                                                                        onclick="farmerFileSelClick(this); return false;">파일선택</a>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="form_imgInfo">
                        <div class="imgInfo">
                            <div class="stit">
                                <h3><i class="fas fa-angle-right"></i>상품 상세설명 이미지</h3>
                                <div class="floatr">
                                    <a href="#" onclick="formInfoHandler(this, 'add'); return false;"
                                       class="btn round mcolor"><i class="fas fa-plus"></i>추가</a>
                                    <a href="#" onclick="formInfoHandler(this, 'del'); return false;"
                                       class="btn round scolor"><i class="fas fa-minus"></i>삭제</a>
                                    <a href="#" onclick="formInfoHandler(this, 'up'); return false;"
                                       class="btn_basic ml5"><i class="fas fa-chevron-up mr0"></i></a>
                                    <a href="#" onclick="formInfoHandler(this, 'down'); return false;"
                                       class="btn_basic"><i class="fas fa-chevron-down mr0"></i></a>
                                </div>
                            </div>
                            <div class="contarea">
                                <table class="tbl02 imgedit">
                                    <tbody>
                                    <tr>
                                        <th>이미지 파일&nbsp;&nbsp;
                                            <span class="tooltip_info">
                                                        <i class="fas fa-question-circle"></i>
                                                        <span class="right"><b>'jpg', 'png'</b> 확장자만 등록 가능합니다.</span>
                                                    </span>
                                        </th>

                                        <td colspan="3" class="withbtn01">
                                            <form class="imgUpload" method="post" enctype="multipart/form-data">
                                                <input type="file" name="imgfile" style="display: none;"
                                                       onchange="imgChangeHandler(this); return false;"><input
                                                    type="text" name="selectedImg" value="" data-type=""
                                                    data-size="0" placeholder="이미지 파일을 선택해 주세요" disabled><a
                                                    href="#" class="btn grey"
                                                    onclick="imgSelClick(this); return false;">파일선택</a>
                                            </form>
                                        </td>
                                        <td rowspan="2" class="img_review">
                                            <div><img class="thumbnail_img" src="" /></div>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="submit" class="tac mt15 mb15">
                        <!-- 집필 중일 경우 버튼 그룹  -->
                        <div id="bGroup_ws_01">
                            <a onclick="registerCommit(this); return false;" data-statusid="ws_02" data-statusnm="완료" data-stage="1" class="btn round mcolor bg big"><i class="fas fa-check"></i>완료 <span class="grey"></span></a>
                            <a href="http://nongbu.site/" data-statusid="ws_02" data-statusnm="취소" data-stage="2" class="btn round mcolor bg big ml15"><i class="fas fa-check"></i>취소 <span class="grey"></span></a>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
</div>
<script>

// 이미지 파일 선택 버튼
function imgSelClick(e) {
	//e.preventDefault();
    $(e).prev().prev().click();
}

// 농부 이미지 파일 선택 버튼
function farmerFileSelClick(e) {
	$(e).prev().prev().prev().click();
}

// 농부 이미지 파일 선택 시 이벤트
function farmerImgChangeHandler(e) {
	var file = $(e)[0].files[0];

	if(typeof file != "undefined") {
		var fileObj = getFileNameExt(file.name);

		var fileName = file.name;
		var fileType = file.type;
		var fileSize = file.size;
		var fileExt = fileType.split("/")[1];

		// 확장자 체크
		if(fileExt != "jpeg" && fileExt != "jpg" && fileExt != "png") {
			$(e).val("");
			alert("올바른 확장자가 아닙니다.\n'jpg', 'png' 확장자만 등록 가능합니다.");

			return false;
		}

		// 파일 이름 표시
        $(e).next().val(fileName);
        $(e).next().attr("data-type", fileType);
        $(e).next().attr("data-size", fileSize);
	} else {
		$(e).val("");
		$(e).next().val("");
		$(e).next().attr("data-type", "");
		$(e).next().attr("data-size", 0);
	}
}

// 이미지 파일 선택 시 이벤트
function imgChangeHandler(e) {
	var file = $(e)[0].files[0];

	if(typeof file != "undefined") {
		var fileObj = getFileNameExt(file.name);

		var fileName = file.name;
		var fileType = file.type;
		var fileSize = file.size;
		var fileExt = fileType.split("/")[1];

		// 확장자 체크
		if(fileExt != "jpeg" && fileExt != "jpg" && fileExt != "png") {
			$(e).val("");
			alert("올바른 확장자가 아닙니다.\n'jpg', 'png' 확장자만 등록 가능합니다.");

			return false;
		}

		// 파일 이름 표시
					$(e).next().val(fileName);
					$(e).next().attr("data-type", fileType);
					$(e).next().attr("data-size", fileSize);

					// 이미지 썸네일 표시
					if(e.files && e.files[0]){
                		var reader = new FileReader();
                		reader.onload = function(event) {
                			$(e).closest("div").find(".thumbnail_img").attr('src',event.target.result);
                		}
                		reader.readAsDataURL(e.files[0]);
                	}
	} else {
		$(e).val("");
		$(e).next().val("");
		$(e).next().attr("data-type", "");
		$(e).next().attr("data-size", 0);
	}
}

// 입력 폼 이벤트 처리
function formInfoHandler(e, action) {
	var cls = $(e).closest("div[class$='Info']").attr("class");
	var clsFilter = cls.split(" ");
	cls = (clsFilter.length == 1)? cls: clsFilter[clsFilter.length - 1];
	var id = "form_" + cls;

	// 추가
	if(action === "add") {
		var div = $("<div class=\"mt15 "+cls+"\"></div>");
		var last = $(e).closest("." + cls);

		// form 추가
		if(last.is("." + cls)) {
			var html = last.html();
			div.append(html).insertAfter(last);

			div.find(".stit h3").hide();
            div.find("td:eq(0) > form > input:eq(0)").val("");
            div.find("td:eq(0) > form > input:eq(1)").val("");
            div.find("td:eq(0) > form > input:eq(1)").attr("data-type", "");
            div.find("td:eq(0) > form > input:eq(1)").attr("data-size", 0);
            div.find("td:eq(1) > div > img").attr("src","");
            div.find("td:eq(2) > input").val("");
            div.find("td:eq(3) > input").val("");


		}
	}

	// 삭제
	if(action === "del") {
		var infoLength = (cls === "examInfo")? $(e).closest("td").find("." + cls).length: $("#" + id + " ." + cls).length;

		if(infoLength > 1) {
			$(e).closest("." + cls).remove();

			// 첫번째 필드에는 타이트 항상 표시
			$("#" + id + " ." + cls).eq(0).find(".stit h3").show();

			// 첫번째 폼 삭제 시 'mt15' class 제거
			if(cls === "examInfo") {
				$("#form_meExamInfo").find(".meExamInfo").each(function(i, e) {
					var first = $(e).find(".examInfo").eq(0);
					$(first).removeClass().addClass(cls);
				});
			}
			else {
				var first = $("#" + id + " ." + cls).eq(0);
				$(first).removeClass().addClass(cls);
			}
		} else {
			alert("입력 필드가 하나 밖에 없으므로 삭제할 수 없습니다.");

			// 입력된 내용은 초기화 시키자..
			if(cls === "meExamInfo") {
				$(e).closest("." + cls).find(".examInfo td:eq(0) > div").html("");
				$(e).closest("." + cls).find(".examInfo td:eq(1) > input").val("");
				$(e).closest("." + cls).find(".examInfo td:eq(2) > input").val("");
			} else if(cls === "examInfo") {
				$(e).closest("." + cls).find("td:eq(0) > div").html("");
				$(e).closest("." + cls).find("td:eq(1) > input").val("");
				$(e).closest("." + cls).find("td:eq(2) > input").val("");
			} else if(cls === "imgInfo") {
				$(e).closest("." + cls).find(".imgUpload > input:eq(0)").val("");
				$(e).closest("." + cls).find(".imgUpload > input:eq(1)").val("");
				$(e).closest("." + cls).find(".imgUpload > input:eq(1)").attr("data-type", "");
				$(e).closest("." + cls).find(".imgUpload > input:eq(1)").attr("data-size", 0);
				$(e).closest("." + cls).find(".thumbnail_img").attr("src", "");

                $(e).closest("." + cls).find("td:eq(1) > div > img").attr("src","");
                $(e).closest("." + cls).find("td:eq(2) > input").val("");
                $(e).closest("." + cls).find("td:eq(3) > input").val("");

			}
		}
	}

	// 입력 폼 위&아래 이동
	if(action === "up" || action === "down") {
		var index = (cls === "examInfo")? $(e).closest("td").find("." + cls).index($(e).closest("." + cls)): $("." + cls).index($(e).closest("." + cls));
		var infoLength = (cls === "examInfo")? $(e).closest("td").find("." + cls).length: $("#" + id + " ." + cls).length;
		var section = null;

		//console.log(index, infoLength);
		if(action === "up") {
			if(index == 0) {
				alert("첫번째 입력 필드 입니다.");
				return false;
			}

			if(index > 0) {
				section = (cls === "examInfo")? $(e).closest("td").find("." + cls).eq(index): $("#" + id + " ." + cls).eq(index);

				if(index == 1) {
					section.removeClass().addClass(cls);
					section.prev().removeClass().addClass("mt15 " + cls);
					section.prev().find(".stit h3").hide();	// 타이틀 숨김
				}
				section.after(section.prev());

				// 첫번째 필드에는 타이트 항상 표시
				if(index == 1) {
					$("#" + id + " ." + cls).eq(0).find(".stit h3").show();
				}
			}
		} else {
			if((index + 1) == infoLength) {
				alert("마지막 입력 필드 입니다.");
				return false;
			}

			if(index >= 0 && (index + 1) < infoLength) {
				section = (cls === "examInfo")? $(e).closest("td").find("." + cls).eq(index): $("#" + id + " ." + cls).eq(index);

				if(index == 0) {
					section.removeClass().addClass("mt15 " + cls);
					section.next().removeClass().addClass(cls);
					section.find(".stit h3").hide();	// 타이틀 숨김
				}
				section.before(section.next());

				// 첫번째 필드에는 타이트 항상 표시
				if(index == 0) {
					$("#" + id + " ." + cls).eq(0).find(".stit h3").show();
				}
			}
		}
	}
}

// 현재 입력 필드 정보 저장
function setInputField(e, fieldName) {
	curInputField = fieldName;
}

// 계약 등록 완료
function registerCommit(e) {
    // form 데이터 생성
	var formData = new FormData();

	var address = $("#address").val();
	var farmer_name = $("#farmer_name").val();
	var farmer_company = $("#farmer_company").val();
	var farmer_comment = $("#farmer_comment").val();

	var farmer_img = $("#farmer_img")[0].files[0];
	var farmer_img_obj = new Object();

	if(farmer_img){
	    farmer_img_obj.fileName = getFileNameExt(farmer_img.name).fname;
	    farmer_img_obj.type = farmer_img.type;
        farmer_img_obj.size = farmer_img.size;
        farmer_img_obj.imgSrc = "/img/" + farmer_img.name;

        formData.append("farmer_img[]", farmer_img);

	    console.log(farmer_img_obj);
	}




    var product_category = $("#product_category").val();
	var product_name = $("#product_name").val();
	var product_attribute = $("#product_attribute").val();
	var sales_day = $("#sales_day").val();
	var delivery_condition = $("#delivery_condition").val();
	var product_local = $("#product_local").val();
	var is_tax = $("#is_tax").val();
	var d_date = $("#d_date").val();

    if(product_img){
        var product_img = $("#product_img")[0].files[0];
        var product_img_obj = new Object();
        product_img_obj.fileName = getFileNameExt(product_img.name).fname;
        product_img_obj.type = product_img.type;
        product_img_obj.size = product_img.size;
        product_img_obj.imgSrc = "/img/" + product_img.name;

        formData.append("product_img[]", product_img);

        console.log(product_img_obj);
    }

    // 이미지 정보 데이터 리스트
    var imgList = new Array();

    // 이미지 정보 리스트 생성(어휘집필)
    $("#form_imgInfo .imgInfo").each(function() {
        // var imgFile = $(this).find(".imgUpload > input:eq(0)")[0].files[0];
        var imgFile = $(this).find("input[name='imgfile']")[0].files[0];
        console.log('imgFile', imgFile);

        if (imgFile) {
            var imgObj = new Object();
            var fileObj = getFileNameExt(imgFile.name);

            imgObj.fileName = fileObj.fname;
            imgObj.type = imgFile.type;
            imgObj.size = imgFile.size;
            imgObj.imgSrc = "/img/" + imgFile.name;

            imgList.push(imgObj);
            console.log("imgList", imgList);
            formData.append("imgfile[]", imgFile);

            console.log("[이미지] " + imgObj.fileName);
        } else {
            console.log("선택된 이미지가 없습니다.");
        }
    });

	var url = "productRegister.do";
	var param = {
			"address": address,
			"farmer_name": farmer_name,
			"farmer_company": farmer_company,
			"farmer_comment": farmer_comment,

			"farmer_img_obj": farmer_img_obj,

	        "product_category": product_category,
			"product_name": product_name,
			"product_attribute": product_attribute,
			"sales_day": sales_day,
			"delivery_condition": delivery_condition,
			"product_local": product_local,
			"is_tax": is_tax,
			"d_date": d_date,

			"product_img_obj": product_img_obj,

			"image_info": imgList,
		};
	formData.append("metadata", JSON.stringify(param)); // meta 정보 저장

	console.log('formData', formData);
	console.log('imgList', imgList);
	// return ;

/*
	$.ajax({
        type: "POST",
        processData : false,
        contentType : false,
        url: url,
        data: formData,
        success:function(result) {
        	console.log("계약 등록 완료!");
        },
        error:function() {
        	console.log("계약 등록 오류!");
        },
        complete:function() {

        }
    });
    */
    alert("계약재배 등록 완료!");
}

</script>
</body>
</html>